"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}(),__assign=this&&this.__assign||function(){return __assign=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++){e=arguments[i];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},__assign.apply(this,arguments)},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{"default":t}};Object.defineProperty(exports,"__esModule",{value:!0});var phaser_1=__importDefault(require("phaser")),KineticScrollingPlugin=function(t){function e(e,i){var s,r,o=t.call(this,e,i)||this;return o.STAGE_INPUT_EVENT_HANDLERS=(s={},s[phaser_1["default"].Input.Events.POINTER_DOWN]=o.beginMove,s[phaser_1["default"].Input.Events.POINTER_MOVE]=o.moveCamera,s[phaser_1["default"].Input.Events.POINTER_UP]=o.endMove,s[phaser_1["default"].Input.Events.POINTER_WHEEL]=o.mouseWheel,s[phaser_1["default"].Input.Events.GAME_OUT]=o.gameOutTracker,s[phaser_1["default"].Input.Events.GAME_OVER]=o.gameOverTracker,s),o.GAME_EVENT_HANDLERS=(r={},r[phaser_1["default"].Core.Events.PRE_RENDER]=o.update,r),o.pointerId=null,o.pressedDown=!1,o.timestamp=0,o.beginTime=0,o.screenX=0,o.screenY=0,o.targetX=0,o.targetY=0,o.autoScrollX=!1,o.autoScrollY=!1,o.startX=0,o.startY=0,o.velocityX=0,o.velocityY=0,o.amplitudeX=0,o.amplitudeY=0,o.directionWheel=0,o.velocityWheelX=0,o.velocityWheelY=0,o.thresholdOfTapTime=100,o.thresholdOfTapDistance=10,o.thresholdReached=!1,o.clearMovementTimer=null,o.now=0,o.clickHelperActiveObjects=[],o.settings={kineticMovement:!0,timeConstantScroll:325,horizontalScroll:!0,verticalScroll:!1,horizontalWheel:!0,verticalWheel:!1,deltaWheel:40,onUpdate:null,button:null},o}return __extends(e,t),Object.defineProperty(e.prototype,"camera",{get:function(){return this.scene.cameras.main},enumerable:!0,configurable:!0}),e.prototype.configure=function(t){this.settings=__assign(__assign({},this.settings),t)},e.prototype.start=function(){this.dragging=!0,this.attachEventHandlers(this.scene.input,this.STAGE_INPUT_EVENT_HANDLERS),this.attachEventHandlers(this.game.events,this.GAME_EVENT_HANDLERS)},e.prototype.stop=function(){this.pressedDown=!1,this.removeEventHandlers(this.scene.input,this.STAGE_INPUT_EVENT_HANDLERS),this.removeEventHandlers(this.game.events,this.GAME_EVENT_HANDLERS)},e.prototype.attachEventHandlers=function(t,e){for(var i in e)e.hasOwnProperty(i)&&t.addListener(i,e[i],this)},e.prototype.removeEventHandlers=function(t,e){for(var i in e)e.hasOwnProperty(i)&&t.removeListener(i,e[i],this)},e.prototype.beginMove=function(t){this.settings.button&&t.button!==this.settings.button||(this.pointerId=t.id,this.startX=t.x,this.startY=t.y,this.screenX=t.worldX,this.screenY=t.worldY,this.pressedDown=!0,this.thresholdReached=!1,this.timestamp=Date.now(),this.beginTime=this.timestamp,this.velocityY=this.amplitudeY=this.velocityX=this.amplitudeX=0)},e.prototype.moveCamera=function(t){var e=this;if(clearTimeout(this.clearMovementTimer),this.pressedDown&&this.pointerId===t.id){this.now=Date.now();var i=this.now-this.timestamp;this.timestamp=this.now;var s=0,r=0;if(!(this.isTap()&&Math.abs(t.worldY-this.screenY)<this.thresholdOfTapDistance&&Math.abs(t.worldX-this.screenX)<this.thresholdOfTapDistance)){if(!this.thresholdReached)return this.thresholdReached=!0,this.startX=t.x,this.startY=t.y,void this.cancelClickEventHelpers();if(this.settings.horizontalScroll&&(s=t.x-this.startX,0!==s&&(this.dragging=!0),this.startX=t.x,this.velocityX=.8*(1e3*s/(1+i))+.2*this.velocityX,this.camera.scrollX-=s),this.settings.verticalScroll&&(r=t.y-this.startY,0!==r&&(this.dragging=!0),this.startY=t.y,this.velocityY=.8*(1e3*r/(1+i))+.2*this.velocityY,this.camera.scrollY-=r),"function"==typeof this.settings.onUpdate){var o=0;this.canCameraMoveX()&&(o=s);var n=0;this.canCameraMoveY()&&(n=r),this.settings.onUpdate(o,n)}this.clearMovementTimer=setTimeout(function(){e.velocityX=0,e.velocityY=0},20)}}},e.prototype.isTap=function(){return this.now-this.beginTime<this.thresholdOfTapTime},e.prototype.canCameraMoveX=function(){var t=this.camera.getBounds();return!!t.isEmpty()||this.camera.scrollX>0&&this.camera.scrollX+this.camera.width<t.right},e.prototype.canCameraMoveY=function(){var t=this.camera.getBounds();return!!t.isEmpty()||this.camera.scrollY>0&&this.camera.scrollY+this.camera.height<t.height},e.prototype.gameOutTracker=function(){this.pointerWithinGame=!1,this.pressedDown=!1},e.prototype.gameOverTracker=function(){this.pointerWithinGame=!0},e.prototype.endMove=function(){clearTimeout(this.clearMovementTimer),this.pointerId=null,this.pressedDown=!1,this.autoScrollX=!1,this.autoScrollY=!1,this.settings.kineticMovement&&(this.now=Date.now(),this.pointerWithinGame?(Math.abs(this.velocityX)>10&&(this.amplitudeX=.8*this.velocityX,this.targetX=Math.round(this.camera.scrollX-this.amplitudeX),this.autoScrollX=!0),Math.abs(this.velocityY)>10&&(this.amplitudeY=.8*this.velocityY,this.targetY=Math.round(this.camera.scrollY-this.amplitudeY),this.autoScrollY=!0)):(this.settings.horizontalScroll&&this.velocityWheelXAbs<.1&&(this.autoScrollX=!0),this.settings.verticalScroll&&this.velocityWheelYAbs<.1&&(this.autoScrollY=!0)))},Object.defineProperty(e.prototype,"velocityWheelXAbs",{get:function(){return Math.abs(this.velocityWheelX)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"velocityWheelYAbs",{get:function(){return Math.abs(this.velocityWheelY)},enumerable:!0,configurable:!0}),e.prototype.update=function(){if(this.elapsed=Date.now()-this.timestamp,this.autoScrollX&&0!==this.amplitudeX){var t=-this.amplitudeX*Math.exp(-this.elapsed/this.settings.timeConstantScroll);this.canCameraMoveX()&&(t>.5||t<-.5)?this.camera.scrollX=this.targetX-t:(this.autoScrollX=!1,this.camera.scrollX=this.targetX)}if(this.autoScrollY&&0!==this.amplitudeY){var t=-this.amplitudeY*Math.exp(-this.elapsed/this.settings.timeConstantScroll);this.canCameraMoveY()&&(t>.5||t<-.5)?this.camera.scrollY=this.targetY-t:(this.autoScrollY=!1,this.camera.scrollY=this.targetY)}this.autoScrollX||this.autoScrollY||(this.dragging=!1),this.settings.horizontalWheel&&this.velocityWheelXAbs>.1&&(this.dragging=!0,this.amplitudeX=0,this.autoScrollX=!1,this.camera.scrollX-=this.velocityWheelX,this.velocityWheelX*=.95),this.settings.verticalWheel&&this.velocityWheelYAbs>.1&&(this.dragging=!0,this.autoScrollY=!1,this.camera.scrollY-=this.velocityWheelY,this.velocityWheelY*=.95)},e.prototype.mouseWheel=function(t,e,i,s){(this.settings.horizontalWheel||this.settings.verticalWheel)&&(this.settings.horizontalWheel&&(this.autoScrollX=!1,this.velocityWheelX+=i,"function"==typeof this.settings.onUpdate&&this.settings.onUpdate(i,this.camera.scrollX>0&&this.camera.scrollX+this.camera.width<this.camera.worldView.width?i:0)),this.settings.verticalWheel&&(this.autoScrollY=!1,this.velocityWheelY+=s,"function"==typeof this.settings.onUpdate&&this.settings.onUpdate(s,this.camera.scrollY>0&&this.camera.scrollY+this.camera.height<this.camera.worldView.height?s:0)))},e.prototype.addClickEvents=function(t,e){var i=this;if(t.getData("kineticScrollingClickHelpers")){var s=t.getData("kineticScrollingClickHelpers");for(var r in e)e.hasOwnProperty(r)&&(s[r]=e[r])}else{var o=__assign({},e);t.setData("kineticScrollingClickHelpers",o),e.inputIsDown=!1,t.setInteractive().on(phaser_1["default"].Input.Events.GAMEOBJECT_POINTER_DOWN,function(){var e=t.getData("kineticScrollingClickHelpers");e.downTimer=setTimeout(function(){e.downTimer=null,i.thresholdReached||(i.clickHelperActiveObjects.push(t),e.inputIsDown=!0,e.down&&e.down(t))},i.thresholdOfTapTime+10)}).on(phaser_1["default"].Input.Events.GAMEOBJECT_POINTER_UP,function(){i.clickHelperActiveObjects.splice(i.clickHelperActiveObjects.indexOf(t));var e=t.getData("kineticScrollingClickHelpers");e.inputIsDown?(e.up&&e.up(t),i.isTap()&&e.click&&e.click(t),e.inputIsDown=!1):e.downTimer&&!i.thresholdReached&&(clearTimeout(e.downTimer),e.down&&e.down(t),e.up&&e.up(t),e.click&&e.click(t))})}},e.prototype.cancelClickEventHelpers=function(){this.clickHelperActiveObjects.forEach(function(t){var e=t.getData("kineticScrollingClickHelpers"),i=e.inputIsDown;e.inputIsDown=!1,i&&e.up&&e.up(t)})},e.NAME="kineticScrolling",e}(phaser_1["default"].Plugins.ScenePlugin);exports["default"]=KineticScrollingPlugin;